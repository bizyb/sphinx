{% extends 'base.html' %}

{% block content %}
<script type="text/javascript">
	
	var failIcon = '&#10007;'; // x
	var passIcon = '&#10003;'; // checkmark
	var passwordValidated = false;
	var inviteValidated = false;
	var usernameValidated = false;

	function successIcon(elemID, icon, status) {
		
		if (status == "success") document.getElementById(elemID).style.color = "green";
	
		else  if (status == "fail") document.getElementById(elemID).style.color = "red";

		document.getElementById(elemID).innerHTML = icon;
	}

	function ajaxValidation(valueType, value, elemID) {

		if (value != "") {
			var url;
			var csrftoken = Cookies.get('csrftoken');
			postData = valueType + "=" + value;

			if (valueType == "username") url = "username-availability";
			else if (valueType == "invite_code") url = "invite-code-validation";

			var xmlhttp = new XMLHttpRequest();
	   		xmlhttp.open("POST", url, true);
	   		xmlhttp.setRequestHeader("X-CSRFToken", csrftoken);
	   		xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	   		xmlhttp.send(postData);

	   		xmlhttp.onreadystatechange = function() {
			    if (this.readyState == 4 && this.status == 200) {
			        var jsonObj = JSON.parse(this.responseText);
			        if (jsonObj.status == 'SUCCESS') {
			        	successIcon(elemID, passIcon, "success");

			        	if (valueType == "username") usernameValidated = true;
			        	else if (valueType == "invite_code") {
			        		inviteError(false);
			        		inviteValidated = true;
			        	}
			        }
			        else {
			        	successIcon(elemID, failIcon, "fail");
			        	if (valueType == "username") usernameValidated = false;
			        	else if (valueType == "invite_code") inviteValidated = false;
			        }	
			    }
			};
   		}
   		else successIcon(elemID, "", "reset");

	}

	function usernameExists(input) {

		ajaxValidation("username", input.value, "username-exists");
	}
	function inviteError(error) {
		inviteValidated = false;

		if (!error) {
			document.getElementById("presubmission-message").innerHTML = "";
			inviteValidated = true;
		}		
		else {
			var html = "Sorry, the invitation code you've provided is invalid.";
			html 	+= " Possible reasons for failure:";
			html 	+= "<ul>";
			html 	+= "<li>The invitation code may have been redeemed already</li>";
			html 	+= "<li>The invitation code belongs to someone else</li>";
			html 	+= "</ul>";
			html 	+= "Make sure you have entered the invitation code, first name,";
			html 	+= " last name, and email address exactly as shown in the";
			html 	+= " invitation email. If the problem continues, please contact support.";
			document.getElementById("presubmission-message").innerHTML = html;
		}

	}

	function validateInvite(input) {

		inviteValidated = false;
		if (input.value == "") {
			document.getElementById("presubmission-message").innerHTML = "";
		}
		else if (input.value.length > 0 && input.value.length != 32) {
			successIcon("invite-is-valid", failIcon, "fail");
			inviteError(true);
		}
		else if (input.value.length == 32 ) {
			ajaxValidation("invite_code", input.value, "invite-is-valid");
	}
}

	function loadForm(formID) {

		if (formID == "signup") {
			document.getElementById("signup").style.display = "block"
			document.getElementById("login").style.display = "none"
		}
		else if (formID == "login") {
			document.getElementById("signup").style.display = "none"
			document.getElementById("login").style.display = "block"
		}

	}

	function patternMatch(string) {

		var pattern = /^(\w+){8,}$/; //at least eight characters and alphanumeric
		matchArr =  string.match(pattern);
		if (matchArr != null && matchArr.length > 0) return true;
		return false;
	}

	function passwordMatch() {
	
		var password1 = document.getElementById('password1').value;
		var password2 = document.getElementById('password2').value;
		passwordValidated = false;

		if (password1 != "" && password1 == password2 && patternMatch(password1)) {
			successIcon('password-match', passIcon, "success"); 
			passwordValidated = true;
		}
		else if ((password2 != "" && password1 != password2) || 
			(password2 != "" && !patternMatch(password1))) {
				successIcon('password-match', failIcon, "fail");
			}
		else {
			successIcon('password-match', "", "reset");
		}
	}
	
	function getPostData(formObj) {


		var fName 	= formObj.first_name.value;
		var lName 	= formObj.last_name.value;
		var uName 	= formObj.username.value;
		var email 	= formObj.email.value;
		var password = formObj.password1.value;
		var team =	formObj.team.value;
		var invite = formObj.invite_code.value;

		var querystring = 'first_name=' + fName + '&last_name=' + lName + '&username=';
		querystring += uName + '&email=' + email + '&password1=' + password;
		querystring += '&team=' + team + '&invite_code=' + invite;

		return querystring;

	}
	
	
	function formSubmit(formObj) {

		// Submit form synchronously and wait for submission status
		
		if (passwordValidated && inviteValidated && usernameValidated) {
	
			var querystring = getPostData(formObj);
			var csrftoken = Cookies.get('csrftoken');
			var xmlhttp = new XMLHttpRequest();
	   		xmlhttp.open("POST", "registration", false);
	   		xmlhttp.setRequestHeader("X-CSRFToken", csrftoken);
	   		xmlhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	   		xmlhttp.send(querystring);

	   		jsonObj = JSON.parse(xmlhttp.responseText);
	   		if (jsonObj.status == 'SUCCESS') thankyouPage();
	   		else registrationFail();
	   	}

	}

	function thankyouPage() {

		var html = "<div class=\"message\" id=\"registration-thankyou\">";
		html += "Thank you for registering. Please click <a href=\"\\\">HERE</a>";
		html += " to login with your new credentials.</div>"
		document.getElementById("registration-form").innerHTML = html;
	}

	function registrationFail() {

		var msg = "Sorry, we were unable to create an account for you. Please";
		msg += " verify your information and try again. If the problem continues, contact support.";
		alert(msg); 
	}
	
</script>
<div class="login-page">
  <div class="form" id="registration-form">
  	<div id="signup">
    <form class="register-form" method="post" action="" onsubmit="formSubmit(this)">
 		{% csrf_token %}
 		<div class="message" id="registration-fail-msg"></div>
      <input type="text" name="first_name" id="first-name" placeholder="First Name" required/>
      <input type="text" name="last_name" id="last-name" placeholder="Last Name" required/>
     <div> <input type="text" name="username" id="username" placeholder="Username"  required 
      		onkeyup="usernameExists(this)"/><div class="username-exists-box" id="username-exists"></div></div>
      <input type="email" name="email" placeholder="Email" required/>


      <div class="message" id="password-requirements">
      	Password must be at least 8 characters long and may contain numbers, letters, and underscores<br>
      	<input type="password" placeholder="Create a password" name="password1" 
      	id="password1" onkeyup="passwordMatch()" required/></div>
      <div><input type="password" placeholder="Confirm your password" name="password2"  required id="password2" onkeyup="passwordMatch()"/>
      <div class="password-match-box" id="password-match"></div></div>

      <div class="team-dropdown">Team
      <select name="team_name" id="team">
      	<option value="3d">3D</option>
          <option value="android">Android</option>
          <option value="backend">Backend</option>
          <option value="frontend">Frontend</option>
          <option value="ios">iOS</option>
          <option value="ml">ML</option>
       </select>
   </div>
       <div><input type="text" id="invite-code" name="invite_code" placeholder="Invite code" required onkeyup="validateInvite(this)"/><div class="invite-validation-box" id="invite-is-valid"></div></div>
      <div class="button"><button id="signup-button">Register</div>
      <div class="message" id="presubmission-message">
      </div>

      <p class="message" onclick="loadForm('login')">Already registered? <a href="#">Sign In</a></p>
    </form>
</div>
<div id="login">
    <form class="login-form" action="" method="post">
    	{% csrf_token %}
      <input type="text" placeholder="username"/>
      <input type="password" placeholder="password"/>
      <button>login</button>
      <p class="message" onclick="loadForm('signup')">Not registered? <a >Create an account</a></p>
      <p class="message"> Coming Soon: <a>Forgot password?</a></p>
    </form>
</div>
  </div>
</div>
{% endblock %}